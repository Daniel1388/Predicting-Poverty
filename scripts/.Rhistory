library(here)
library(tidyverse)
library(caret)
library(doParallel)
library(randomForest)
library(Boruta)
library(fastDummies)
library(gamlr)
library(xgboost)
library(themis)
library(kableExtra)
cl <- makeCluster(detectCores()- 1, type='PSOCK')
registerDoParallel(cl)
detectCores()
train_hogares<-readRDS(here("train_hogares.Rds","data"))
train_hogares<-readRDS(here("data","train_hogares.Rds"))
train_personas<-readRDS(here("data","train_personas.Rds"))
train_hogares<-readRDS(here("data","train_hogares.Rds"))
train_personas<-readRDS(here("data","train_personas.Rds"))
train_personas<-readRDS(here("data","train_personas.Rds"))
test_hogares<-readRDS(here("data","test_hogares.Rds"))
test_personas<-readRDS(here("data","test_personas.Rds"))
#Seleccionar variables que están en test.
train_personas_2 <- train_personas %>% select(colnames(test_personas),Ingtot,-contains("Fex"),
Depto,Clase)
train_hogares_2 <- train_hogares %>% select(colnames(test_hogares),Pobre)
set.seed(1)
#Split para hogares
id_train_sample_hog <- sample(1:nrow(train_hogares_2),
nrow(train_hogares_2)*0.1)
training_set_hog <- train_hogares_2[-id_train_sample_hog,]
validation_set_hog <- train_hogares_2[id_train_sample_hog,]
set.seed(1)
id_feature_selection_sample_ind <- sample(1:nrow(training_set_indiv),
round(nrow(training_set_indiv)*0.20),0)
set.seed(1)
#Split para individuos (solamente para feature selection)
id_train_sample_indiv <- sample(1:nrow(train_personas_2),
round(nrow(train_personas_2)*0.1),0)
training_set_indiv <- train_personas_2[-id_train_sample_indiv,]
validation_set_indiv <- train_personas_2[id_train_sample_indiv,]
id_feature_selection_sample_ind <- sample(1:nrow(training_set_indiv),
round(nrow(training_set_indiv)*0.2),0)
#Se seleccionan variables
feature_selection_set <- training_set_indiv[id_feature_selection_sample_ind,] %>%
select(
Ingtot,
Clase,
P6020,#genero
P6040,#años
P6050,#parentesco jefe de hogar
P6090,#cotizante#no tiene variación
P6210,#nivel educativo
P6240,#grado
P6800,#HORAS DE TRABAJO#200K NAS
P6870,#PERSOANS EN LA EMPRESA#200K NAS
P6920,#COTIZACION PENSIONES, 200K NAS
P7040,#OTRO NEGOCIO,
P7090,#quiere trabajar mas horas
P7505,#subsidios
P7495#recibio pago de arrendamiento o pension
) %>%
filter(complete.cases(.)) %>%
mutate(age_2=P6040^2)
#Se convierten a factores
feature_selection_set_2 <- feature_selection_set %>%
mutate_at(vars(-contains(c("Ingtot","P6040","P6800","age_2"))),as.factor)
set.seed(1)
feature_selection_sample_hog <- sample(1:nrow(training_set_hog),
round(nrow(training_set_hog)*0.3),0)
#Muestreo debe ser a nivel de hogar para agregar los ingresos.
id_feature_selection_sample_hog <- training_set_hog[feature_selection_sample_hog,"id"]
#Selección de variables individuales de acuerdo a partición de hogares
feature_selection_set_indiv_clas <- train_personas_2[train_personas_2$id%in%id_feature_selection_sample_hog$id,] %>%
select(
Ingtot,
id,
Clase,
P6020,#genero
P6040,#años
P6050,#parentesco jefe de hogar
P6090,#cotizante#no tiene variación
P6210,#nivel educativo
P6240,#grado
P6800,#HORAS DE TRABAJO#200K NAS
P6870,#PERSOANS EN LA EMPRESA#200K NAS
P6920,#COTIZACION PENSIONES, 200K NAS
P7040,#OTRO NEGOCIO,
P7090,#quiere trabajar mas horas
P7505,#subsidios
P7495#recibio pago de arrendamiento o pension
) %>%
mutate(age_2=P6040^2)
#Seleccionar y convetri en factores
feature_selection_set_indiv_clas_2 <- feature_selection_set_indiv_clas %>%
mutate_at(vars(-contains(c("Ingtot","P6040","P6800","age_2"))),as.factor)
#Función que crea la moda
getmode <- function(v) {
uniqv <- unique(v)
uniqv[which.max(tabulate(match(v, uniqv)))]
}
#Seleccionar variables y crear nuevas variables
feature_selection_set_indivhog_clas <- feature_selection_set_indiv_clas_2 %>%
mutate(
jefe_hogar_mujer=ifelse(P6050%in%1&P6020%in%2,1,0)) %>%
group_by(id) %>%
mutate(dependency_ratio=sum(P6040>=65,na.rm=T)/n(),
old_radio=sum(P6040>=60,na.rm=T)/n(),
age_head=ifelse(P6050%in%1,P6040,NA)
) %>%
fill(age_head,.direction = 'downup') %>%
mutate(
clase_mode=getmode(Clase),
P6020_mode=getmode(P6020),
P6050_mode=getmode(P6050),
P6090_mode=getmode(P6090),
P6210_mode=getmode(P6210),
P6240_mode=getmode(P6240),
P6870_mode=getmode(P6870),
P6920_mode=getmode(P6920),
P7040_mode=getmode(P7040),
P7090_mode=getmode(P7090),
P7505_mode=getmode(P7505),
P7495_mode=getmode(P7495),
avg_ingtot=mean(Ingtot,na.rm=T),
median_ingtot=median(Ingtot,na.rm=T),
avg_age=mean(P6040,na.rm=T),
median_age=median(Ingtot,na.rm=T),
avg_horas=mean(P6800,na.rm=T),
median_horas=median(P6800,na.rm=T)
) %>%
ungroup() %>%
select(id,jefe_hogar_mujer,dependency_ratio,old_radio,age_head,contains(c("mode","avg","median"))) %>%
distinct
